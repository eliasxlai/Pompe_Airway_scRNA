---
title: "Merge"
author: "Elias Lai"
subtitle: ElMallah Lab, Duke University
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, comment = NA, 
                      message = FALSE, warning = FALSE,
                      fig.height = 6, fig.width = 9, fig.align = "center")
```

```{r load-packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(Seurat)
library(DropletUtils)
library(dplyr)
library(Matrix)
library(cowplot)
library(sctransform)
library(ggplot2)
library(SoupX)
library(here)
library(pheatmap)
library(EnhancedVolcano)
library(slingshot)
library(RColorBrewer)
library(scales)

# gaa <- readRDS("output/gaa.rds")
# gaa.markers <- readRDS("output/gaamarkers.rds")
gaa_withoutdoublets <- readRDS("output/gaa_withoutdoublets.rds")
# control <- readRDS("output/control.rds")
# control.markers <- readRDS("output/controlmarkers.rds")
control_withoutdoublets <- readRDS("output/control_withoutdoublets.rds")

# gaa_merge <- readRDS("output/gaa_merge.rds")
# gaa_merge.markers <- readRDS("output/gaa_merge.markers.rds")
```

```{r setup, message = FALSE, warning = FALSE}
control_withoutdoublets$condition <- "Control"
gaa_withoutdoublets$condition <- "GAA KO"

gaa_merge <- merge(x=control_withoutdoublets,y=c(gaa_withoutdoublets))
saveRDS(gaa_merge, file = "output/gaa_merge.rds")
rm(gaa_withoutdoublets, control_withoutdoublets)

gaa_merge <- NormalizeData(gaa_merge, normalization.method = "LogNormalize", scale.factor = 10000)
gaa_merge <- FindVariableFeatures(gaa_merge, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(gaa_merge)
gaa_merge <- ScaleData(gaa_merge, features = all.genes)
gaa_merge <- RunPCA(object = gaa_merge, verbose = FALSE)
ElbowPlot(gaa_merge, ndims = 30)
gaa_merge <- FindNeighbors(object = gaa_merge, dims = 1:20)
gaa_merge <- FindClusters(object = gaa_merge, resolution = 1)
gaa_merge <- RunUMAP(object = gaa_merge, dims = 1:20,min.dist = 1, n.neighbors = 40, spread = 5, local.connectivity = 20)

DimPlot(gaa_merge, reduction = "umap", label = TRUE)
DimPlot(gaa_merge, reduction = "umap", label = F,group.by = "condition")
saveRDS(gaa_merge, file = "output/gaa_merge.rds")

gaa_merge.markers <- FindAllMarkers(gaa_merge, only.pos = TRUE, min.pct = 0.25,
                                  logfc.threshold = 0.25)
saveRDS(gaa_merge.markers, file = "output/gaa_merge.markers.rds")
```

```{r featureplots, message = FALSE, warning = FALSE}
# Cluster 3: Alveolar Fibroblast
FeaturePlot(gaa_merge, c("Ces1d", "Pdgfra"))
# Cluster #: Adventitial Fibroblast
FeaturePlot(gaa_merge, c("Pi16", "Pdgfra"))
# Cluster #: Pericyte
FeaturePlot(gaa_merge, c("Hhip", "Pdgfra"))
# Cluster 5: Mesothelial
FeaturePlot(gaa_merge, c("Dcn", "Msln", "Wt1"))
# Cluster 7: Capillary Endothelial
FeaturePlot(gaa_merge, c("Tmem100", "Ednrb", "Pecam1"))
# Cluster 8: Smooth Muscle
FeaturePlot(gaa_merge, c("Acta2", "Myh11"))
# Cluster 9: Type 2 Pneumocytes
FeaturePlot(gaa_merge, c("Sftpc", "Sftpd"))
# Cluster 15: Lymphatic Endothelial
FeaturePlot(gaa_merge, c("Mmrn1", "Lyve1", "Pecam1"))
# Cluster 17: Ciliated
FeaturePlot(gaa_merge, c("Foxj1"))
# Cluster 18: Goblet+Club
FeaturePlot(gaa_merge, c("Scgb1a1", "Bpifb1"))
# Cluster 19: Type 1 Pneumocytes
FeaturePlot(gaa_merge, c("Rtkn2"))
# Cluster 20: B
FeaturePlot(gaa_merge, c("Cd79b", "Ptprc"))
# Cluster 21: CD8+ T
FeaturePlot(gaa_merge, c("Trbc2", "Cd8b1", "Ly6c2", "Ptprc"))
```

```{r label, message = FALSE, warning = FALSE}
DimPlot(gaa_merge, reduction = "umap", label = TRUE, pt.size = 0.001) + NoLegend()
gaa_merge <- RenameIdents(gaa_merge, 
                    '20' = "Capillary Endothelial",
                    '7' = "Capillary Endothelial",
                    '19' = "Capillary Endothelial",
                    '16' = "Lymphatic Endothelial",
                    '12' = "Smooth Muscle",
                    '23' = "Smooth Muscle",
                    '14' = "Pericyte",
                    '8' = "Type II Pneumocyte",
                    '27' = "Type II Pneumocyte",
                    '25' = "Type II Pneumocyte",
                    '22' = "Type I Pneumocyte",
                    '15' = "Ciliated",
                    '26' = "Mesothelial",
                    '6' = "Mesothelial",
                    '17' = "Mesothelial",
                    '28' = "Adventitial Fibroblast",
                    '4' = "Adventitial Fibroblast",
                    '1' = "Alveolar Fibroblast",
                    '21' = "Goblet+Club+Basal",
                    '24' = "Immune")
DimPlot(gaa_merge, reduction = "umap", label = TRUE, pt.size = 0.001) + NoLegend()
```





